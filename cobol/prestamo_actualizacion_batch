 IDENTIFICATION DIVISION.
       PROGRAM-ID. LOAN_UPDATE_BATCH.
       AUTHOR. YOUR-NAME.
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT LOAN-FILE ASSIGN TO 'LOANS.DAT'
               ORGANIZATION IS LINE SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               I-O.
           SELECT PAYMENT-FILE ASSIGN TO 'PAYMENTS.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD LOAN-FILE.
       01 LOAN-RECORD.
           05 LOAN-ID        PIC 9(6).
           05 CLIENT-ID      PIC 9(6).
           05 AMOUNT         PIC 9(9)V99.
           05 INTEREST       PIC 9(3)V99.
           05 TERM-MONTHS    PIC 9(3).
           05 STATUS         PIC X(10).
           05 PAID-MONTHS    PIC 9(3).

       FD PAYMENT-FILE.
       01 PAYMENT-RECORD.
           05 PAY-LOAN-ID    PIC 9(6).
           05 NUM-PAYMENTS   PIC 9(3).

       WORKING-STORAGE SECTION.
       01 WS-EOF          PIC X VALUE 'N'.
           88 EOF VALUE 'Y'.
           88 NOT-EOF VALUE 'N'.

       PROCEDURE DIVISION.
       BEGIN.
           OPEN I-O LOAN-FILE
           OPEN INPUT PAYMENT-FILE
           PERFORM UNTIL EOF
               READ PAYMENT-FILE
                   AT END SET EOF TO TRUE
                   NOT AT END
                       PERFORM UPDATE-LOAN
               END-READ
           END-PERFORM
           CLOSE LOAN-FILE
           CLOSE PAYMENT-FILE
           DISPLAY 'Batch loan update completed.'
           STOP RUN.

       UPDATE-LOAN.
           * Buscar el préstamo correspondiente
           READ LOAN-FILE
               AT END DISPLAY 'Loan ID ' PAY-LOAN-ID ' not found'
               NOT AT END
                   IF LOAN-ID = PAY-LOAN-ID
                       ADD NUM-PAYMENTS TO PAID-MONTHS
                       IF PAID-MONTHS >= TERM-MONTHS
                           MOVE 'CLOSED' TO STATUS
                       END-IF
                       REWRITE LOAN-RECORD
                   ELSE
                       * Mantener en bucle hasta encontrar el préstamo
                       REPOSITION LOAN-FILE
                       PERFORM UNTIL LOAN-ID = PAY-LOAN-ID OR EOF
                           READ LOAN-FILE
                               AT END SET EOF TO TRUE
                           END-READ
                       END-PERFORM
                       IF NOT EOF
                           ADD NUM-PAYMENTS TO PAID-MONTHS
                           IF PAID-MONTHS >= TERM-MONTHS
                               MOVE 'CLOSED' TO STATUS
                           END-IF
                           REWRITE LOAN-RECORD
                       END-IF
                   END-IF
           END-READ.
