IDENTIFICATION DIVISION.
PROGRAM-ID. LOAN_REPORT_BATCH.
ENVIRONMENT DIVISION.
DATA DIVISION.
WORKING-STORAGE SECTION.
EXEC SQL
   INCLUDE SQLCA
END-EXEC.

01 WS-CLIENT-ID    PIC 9(6) VALUE ZEROS.
01 WS-STATUS-FILT  PIC X(10) VALUE SPACES.
01 WS-LOAN-ID      PIC 9(6).
01 WS-AMOUNT       PIC 9(9)V99.
01 WS-STATUS       PIC X(10).
01 TOTAL-AMOUNT    PIC 9(12)V99 VALUE 0.
01 COUNT           PIC 9(5) VALUE 0.
01 AVG-AMOUNT      PIC 9(9)V99 VALUE 0.

PROCEDURE DIVISION.
    * Leer filtros desde fichero batch (opcional)
    OPEN INPUT FILTER-FILE
    READ FILTER-FILE INTO WS-CLIENT-ID, WS-STATUS-FILT
        AT END DISPLAY 'Fin de filtros'
    END-READ.

    * Cursor con filtros: se aplican si hay valores
    EXEC SQL
       DECLARE C2 CURSOR FOR
           SELECT LOAN_ID, CLIENT_ID, AMOUNT, STATUS
             FROM LOANS_TABLE
            WHERE (CLIENT_ID = :WS-CLIENT-ID OR :WS-CLIENT-ID = 0)
              AND (STATUS = :WS-STATUS-FILT OR :WS-STATUS-FILT = ' ')
    END-EXEC.

    EXEC SQL OPEN C2 END-EXEC.

    PERFORM UNTIL SQLCODE = 100
        EXEC SQL FETCH C2 INTO :WS-LOAN-ID, :WS-CLIENT-ID, :WS-AMOUNT, :WS-STATUS END-EXEC
        IF SQLCODE = 0
           ADD 1 TO COUNT
           ADD WS-AMOUNT TO TOTAL-AMOUNT
           DISPLAY 'Préstamo:' WS-LOAN-ID
                   ' Cliente:' WS-CLIENT-ID
                   ' Importe:' WS-AMOUNT
                   ' Estado:' WS-STATUS
        END-IF
    END-PERFORM.

    IF COUNT > 0
       COMPUTE AVG-AMOUNT = TOTAL-AMOUNT / COUNT
       DISPLAY 'Total préstamos:' COUNT
               ' Promedio importe:' AVG-AMOUNT
    END-IF.

    EXEC SQL CLOSE C2 END-EXEC.
    CLOSE FILTER-FILE.
    STOP RUN.
